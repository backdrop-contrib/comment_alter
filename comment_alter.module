<?php

/**
 * @file
 * Provides UI to alter nodes' parameters from comment forms.
 *
 * @author
 * CSÉCSY László <boobaa@kybest.hu>
 */

/**
 * Implements hook_form_FORM_ID_alter().
 *
 * @see comment_alter_form_field_ui_field_edit_form_alter_submit()
 */
function comment_alter_form_field_ui_field_edit_form_alter(&$form, &$form_state, $form_id) {
  // Image fields and file fields are not supported by now, peroid.
  if ($form['#field']['type'] == 'image' || $form['#field']['type'] == 'file') {
    return;
  }
  if ($form['instance']['entity_type']['#value'] == 'node') {
    // Additional custom field values will be automatically stored in the
    // database, so custom save mechanism is not necessary.
    $form['instance']['comment_alter'] = array(
      '#type' => 'checkbox',
      '#title' => t('Enable altering this field from comments.'),
      '#weight' => $form['instance']['required']['#weight'] + 0.5,
      '#default_value' => !empty($form['#instance']['comment_alter']),
    );
  }
}

/**
 * Implements hook_form_BASE_FORM_ID_alter().
 *
 * @see comment_alter_comment_insert()
 */
function comment_alter_form_comment_form_alter(&$form, &$form_state, $form_id) {
  $node = $form['#node'];
  $field_infos = field_info_instances('node', $node->type);
  $comment_alter_fields = array();
  foreach ($field_infos as $field_name => $value) {
    if (!empty($value['comment_alter'])) {
      $comment_alter_fields[] = $field_name;
    }
  }
  // Add widgets to comment form if comment form is new,
  // and if comment alter fields are available.
  if (empty($form['cid']['#value']) && !empty($comment_alter_fields)) {
    // OK, let's twist things a little bit. Save our precious $form, call
    // field_attach_form() which modifies it (by adding the fields),
    // save the full form with all the fields, restore our precious saved
    // form without the fields, and add only the needed fields to it.
    // Simple, isn't it? Weird, but works; patches welcome for a less
    // resource-hungry version (or simply 'better', by any means).
    $precious_form = $form;
    field_attach_form('node', $node, $form, $form_state, $node->language);
    $full_form = $form;
    $form = $precious_form;

    // Every comment alter field goes to the root of the comment form so
    // this enables that other modules can re-order or group the fields.
    // Because fields go to the root of the comment form, they get a
    // prefix to avoid conflicts with another modules or fields. This
    // prefix comes from comment_alter_field_extra_fields().
    $field_infos = field_info_extra_fields('comment', 'comment_node_' . $node->type, 'form');
    // $field_alias holds the original and the prefixed field name pairs.
    $field_alias = array();
    foreach ($field_infos as $field_name => $value) {
      if (substr($field_name, 0, 14) == 'comment_alter_') {
        $field_alias[substr($field_name, 14)] = $field_name;
      }
    }

    $alterable_fields = array();
    foreach ($comment_alter_fields as $field_name) {
      if (!empty($full_form[$field_name]) && $full_form[$field_name]['#access']) {
        $field_language = $full_form[$field_name]['#language'];
        $field_value = array();
        // Not sure that there is a language key in the field if
        // the field value is empty.
        if (!empty($node->{$field_name}[$field_language])) {
          $field_value[$field_language] = $node->{$field_name}[$field_language];
        }
        $form[$field_alias[$field_name] . '_old'] = array(
          '#type' => 'value',
          '#value' => $field_value,
        );
        $form[$field_alias[$field_name]] = $full_form[$field_name];
        // TODO: This doesn't seem to be working properly: if the extra field
        // is set to last, it even gets displayed above comment subject.
        $form[$field_alias[$field_name]]['#weight'] = $field_infos[$field_alias[$field_name]]['weight'];

        $alterable_fields[$field_name] = $field_alias[$field_name];
      }
    }

    if (!empty($alterable_fields)) {
      $form['comment_alter'] = array(
        '#type' => 'value',
        '#value' => array('fields' => $alterable_fields, 'old_vid' => $node->vid),
      );
    }
  }
}

/**
 * Implements hook_comment_insert().
 *
 * @see comment_alter_form_comment_form_alter()
 */
function comment_alter_comment_insert($comment) {
  // Do not try to save anything if there is nothing that was allowed to be
  // changed from the comment form.
  if (isset($comment->comment_alter)) {
    $changed_fields = array();
    foreach ($comment->comment_alter['fields'] as $field => $field_alias) {
      if ($comment->{$field_alias . '_old'} != $comment->{$field_alias}) {
        $changed_fields[$field] = $field_alias;
      }
    }

    if (!empty($changed_fields)) {
      $node = node_load($comment->nid);
      foreach ($changed_fields as $field => $field_alias) {
        $node->{$field} = $comment->{$field_alias};
      }
      // Creating a new node revision regardless the node type settings.
      $node->revision = TRUE;
      node_save($node);
      $comment_alter = array(
        'old_vid' => $comment->comment_alter['old_vid'],
        'new_vid' => $node->vid,
        'cid' => $comment->cid,
      );
      drupal_write_record('comment_alter', $comment_alter);
    }
  }
}

/**
 * Implements hook_comment_load().
 */
function comment_alter_comment_load($comments) {
  $result = db_query('SELECT cid, old_vid, new_vid FROM {comment_alter} WHERE cid IN (:cids)', array(':cids' => array_keys($comments)));
  foreach ($result as $row) {
    $comments[$row->cid]->comment_alter['old_vid'] = $row->old_vid;
    $comments[$row->cid]->comment_alter['new_vid'] = $row->new_vid;
  }
}

/**
 * Implements hook_comment_view().
 *
 * @see diff_diffs_show()
 */
function comment_alter_comment_view($comment, $view_mode, $langcode) {
  if (($view_mode == 'full') && isset($comment->comment_alter)) {
    $node = node_load($comment->nid);
    $old_vid = &$comment->comment_alter['old_vid'];
    $new_vid = &$comment->comment_alter['new_vid'];
    module_load_include('inc', 'diff', 'diff.pages');

    // A stripped-down version of diff_diffs_show().
    // Attaches the CSS.
    $build['#attached'] = diff_build_attachments();
    $state = variable_get('diff_default_state_node', 'raw');
    $node_revisions = node_revision_list($node);
    $old_node = node_load($node->nid, $old_vid);
    $new_node = node_load($node->nid, $new_vid);
    // Generate table header (date, username, log message).
    $old_header = t('!date by !username', array(
      '!date' => l(format_date($old_node->revision_timestamp), "node/$node->nid/revisions/$old_node->vid/view", array('absolute' => 1)),
      '!username' => theme('username', array('account' => $node_revisions[$old_vid])),
    ));
    $new_header = t('!date by !username', array(
      '!date' => l(format_date($new_node->revision_timestamp), "node/$node->nid/revisions/$new_node->vid/view", array('absolute' => 1)),
      '!username' => theme('username', array('account' => $node_revisions[$new_vid])),
    ));
    $old_log = $old_node->log != '' ? '<p class="revision-log">' . filter_xss($old_node->log) . '</p>' : '';
    $new_log = $new_node->log != '' ? '<p class="revision-log">' . filter_xss($new_node->log) . '</p>' : '';
    $header = _diff_default_header($old_header, $new_header);
    $rows = array();
    if ($old_log || $new_log) {
      $rows['logs'] = array(
        array(
          'data' => $old_log,
          'colspan' => 2,
        ),
        array(
          'data' => $new_log,
          'colspan' => 2,
        ),
      );
    }
    $rows = array_merge($rows, _diff_body_rows($old_node, $new_node, $state));
    $build['diff_table'] = array(
      '#theme' => 'table__diff__standard',
      '#header' => $header,
      '#rows' => $rows,
      '#attributes' => array('class' => array('diff')),
      '#colgroups' => _diff_default_cols(),
      '#sticky' => FALSE,
    );
    $comment->content['comment_alter'] = $build;
  }
}

/**
 * Implements hook_comment_delete().
 */
function comment_alter_comment_delete($comment) {
  db_delete('comment_alter')
    ->condition('cid', $comment->cid)
    ->execute();
}

/**
 * No need to implement hook_comment_update(), hook_comment_presave(),
 * hook_comment_publish(), hook_comment_unpublish() nor
 * hook_comment_view_alter().
 */

/**
 * Implements hook_field_extra_fields().
 */
function comment_alter_field_extra_fields() {
  $return = array();
  foreach (node_type_get_types() as $type) {
    $field_infos = field_info_instances('node', $type->type);
    $comment_alter_fields = array();
    foreach ($field_infos as $field_name => $value) {
      if (!empty($value['comment_alter'])) {
        $comment_alter_fields[] = $field_name;
      }
    }
    $weight = 0;
    foreach ($comment_alter_fields as $field_name) {
      $field = field_info_instance('node', $field_name, $type->type);
      $return['comment']['comment_node_' . $type->type]['form']['comment_alter_' . $field_name] = array(
        'label' => $field['label'],
        'description' => $field['description'],
        'weight' => $weight,
      );
      $weight++;
    }
  }
  return $return;
}
